<!DOCTYPE html>
<html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<title>Job Result</title>
	<script language="JavaScript">
	<!--

	var results_str = 
		"T_ecv_ACCEPT_ORDER_DATA.csv置き換え,2019-04-08T05:04:38,2019-04-08T05:07:33,00:02:55\n"
		+ "T_ecv_ACCEPT_ORDER_DATA_union作成,2019-04-08T04:50:59,2019-04-08T05:04:37,00:13:38\n"
		+ "T_ecv_ACCEPT_ORDER_DETAIL_DATA.csv置き換え,2019-04-08T06:05:45,2019-04-08T06:08:32,00:02:47\n"
		+ "T_ecv_ACCEPT_ORDER_DETAIL_DATA_union作成,2019-04-08T05:55:39,2019-04-08T06:05:43,00:10:04\n"
		+ "T_ecv_ORDER_LOG.csv置き換え,2019-04-08T06:03:21,2019-04-08T06:05:51,00:02:30\n"
		+ "T_ecv_ORDER_LOG_union作成,2019-04-08T05:55:07,2019-04-08T06:03:20,00:08:13\n"
		+ "T_ecvg_ACCEPT_ORDER_DATA.csv置き換え,2019-04-08T04:52:35,2019-04-08T04:52:51,00:00:16\n"
		+ "T_ecvg_ACCEPT_ORDER_DATA_union作成,2019-04-08T04:51:37,2019-04-08T04:52:33,00:00:56\n"
		+ "T_ecvg_ACCEPT_ORDER_DETAIL_DATA.csv作成,2019-04-08T05:55:16,2019-04-08T05:55:36,00:00:20\n"
		+ "T_ecvg_ACCEPT_ORDER_DETAIL_DATA_union作成,2019-04-08T05:54:40,2019-04-08T05:55:16,00:00:36\n"
		+ "T_ecvg_ORDER_LOG.csv置き換え,2019-04-08T05:55:11,2019-04-08T05:55:30,00:00:19\n"
		+ "T_ecvg_ORDER_LOG_union作成,2019-04-08T05:54:39,2019-04-08T05:55:10,00:00:31\n"
		+ "T_gecs_ACCEPT_ORDER_DATA.csv置き換え,2019-04-08T04:53:02,2019-04-08T04:53:14,00:00:12\n"
		+ "T_gecs_ACCEPT_ORDER_DATA_union作成,2019-04-08T04:52:37,2019-04-08T04:53:01,00:00:24\n"
		+ "T_gecs_ACCEPT_ORDER_DETAIL_DATA.csv置き換え,2019-04-08T05:55:59,2019-04-08T05:56:12,00:00:13\n"
		+ "T_gecs_ACCEPT_ORDER_DETAIL_DATA_union作成,2019-04-08T05:55:38,2019-04-08T05:55:58,00:00:20\n"
		+ "T_gecs_ORDER_LOG.csv置き換え,2019-04-08T05:55:55,2019-04-08T05:56:07,00:00:12\n"
		+ "T_gecs_ORDER_LOG_union作成,2019-04-08T05:55:37,2019-04-08T05:55:54,00:00:17\n"
		+ "T_man_目標マスタ作成,2019-04-05T19:50:44,2019-04-05T19:50:57,00:00:13\n"
		+ "M_ec_会員マスタ作成,2019-04-08T06:00:03,2019-04-08T06:30:43,00:30:40\n"
		+ "C_ecv_受注明細作成,2019-04-08T06:30:48,2019-04-08T07:29:31,00:58:43\n"
		+ "C_gec_受注明細作成,2019-04-08T06:30:51,2019-04-08T06:35:30,00:04:39\n"
		+ "C_tml_受注明細作成,2019-04-01T18:56:17,2019-04-01T18:57:16,00:00:59\n"
		+ "C_ec_受注明細作成,2019-04-08T07:29:33,2019-04-08T07:57:32,00:27:59\n"
		+ "C_ec_受注作成,2019-04-08T07:57:34,2019-04-08T08:15:29,00:17:55\n"
		+ "C_ec_アクティブ作成,2019-04-08T08:15:30,2019-04-08T10:15:39,02:00:09\n"
		+ "C_ec_商品作成,2019-04-08T07:57:35,2019-04-08T08:42:53,00:45:18\n"
		+ "C_ec_期間別受注作成,2019-04-08T10:16:01,2019-04-08T10:58:57,00:42:56";

	function onload()
	{
		// 処理日
		var disp_dt = new Date();
		
		// ログを配列にする
		var log_infos = [];
		var log_ary = results_str.split(/\r\n|\n/);
		for( var i=0; i<log_ary.length; i++){
			var log = log_ary[i];
			if( log.length==0 ){continue;}
			var one_log = log.split(/,/);
			
			var start_dt = new Date(Date.parse(one_log[1]));
			var end_dt = new Date(Date.parse(one_log[2]));
			
			// disp_dtだけを追加する
			if(
				(start_dt.getFullYear()!=disp_dt.getFullYear()) ||
				(start_dt.getMonth()!=disp_dt.getMonth()) ||
				(start_dt.getDate()!=disp_dt.getDate())
			){
				continue
			}

			log_infos.push({
				'name' : one_log[0],
				'start': start_dt,
				'end'  : end_dt
			});
		}
		console.log(log_infos);

		// 一番小さい時刻と一番大きな時刻を取得
		var min_tm = log_infos[0]['start'];
		var max_tm = log_infos[0]['end'];
		for( var i=0; i<log_infos.length; i++){
			if(log_infos[i]['start']<min_tm){ min_tm = log_infos[i]['start']}
			if(log_infos[i]['end']<min_tm){ min_tm = log_infos[i]['end']}
			if(log_infos[i]['start']>max_tm){ max_tm = log_infos[i]['start']}
			if(log_infos[i]['end']>max_tm){ max_tm = log_infos[i]['end']}
		}
		console.log('min'+min_tm);
		console.log('max'+max_tm);

		// 絵の幅を決定
		var NAME_WIDTH = 300;	// 名前の幅
		var HOUR_WIDTH = 100;	// １時間の幅
		var ONE_LINE_HEIGHT = 30;	// １行の高さ
		var LINE_PADDING = 8;	// padding
		var width = NAME_WIDTH
			+ (max_tm.getHours() - min_tm.getHours() + 1) * HOUR_WIDTH;
		var height = ONE_LINE_HEIGHT * (1+log_infos.length);
		console.log('width:'+ width);
		console.log('height:'+ height);
		// キャンバスのサイズを変更する
		document.getElementById("can1").setAttribute('width', width);
		document.getElementById("can1").setAttribute('height', height);

		// 描画
		var can1 = document.getElementById("can1");
		var ctx1 = can1.getContext("2d");
		
		// ヘッダ
		ctx1.fillStyle = "rgb(150,200,100)";
		ctx1.fillRect(0,0,width,ONE_LINE_HEIGHT);
		ctx1.fillStyle = "rgb(200,230,180)";
		ctx1.fillRect(0,ONE_LINE_HEIGHT+1, NAME_WIDTH,height);
		// 行
		ctx1.fillStyle = "rgba(200,200,200,0.15)";
		for( var i=2; i<(log_infos.length+1); i+=2){
			ctx1.fillRect(0,i*ONE_LINE_HEIGHT, width, ONE_LINE_HEIGHT);
		}

		// 時刻ごとの罫線（縦線）
		ctx1.strokeStyle = "#eed";
		ctx1.lineWidth = 1;
		for( var i=0; i<(max_tm.getHours() - min_tm.getHours() + 1); i++){
			ctx1.beginPath();
			ctx1.moveTo(
				NAME_WIDTH + HOUR_WIDTH*i, 
				0
			)
			ctx1.lineTo(
				NAME_WIDTH + HOUR_WIDTH*i, 
				height
			)
			ctx1.closePath();
			ctx1.stroke();
		}
		// ジョブごとの罫線（横線）
		ctx1.strokeStyle = "#bba";
		for( var i=0; i<(log_infos.length+1); i++){
			ctx1.beginPath();
			ctx1.moveTo(
				0, 
				ONE_LINE_HEIGHT*i
			)
			ctx1.lineTo(
				width,
				ONE_LINE_HEIGHT*i
			)
			ctx1.closePath();
			ctx1.stroke();
		}
		// 時刻
		ctx1.fillStyle = "rgb(0,0,0)";
		ctx1.font = "10px メイリオ";
		var min_hour = min_tm.getHours();
		for( var i=0; i<(max_tm.getHours() - min_tm.getHours() + 1); i++){
			ctx1.fillText(
				(min_hour + i) + ':00',
				NAME_WIDTH + HOUR_WIDTH * i,
				ONE_LINE_HEIGHT
			)
		}

		// ジョブごとの時刻を描画する
		// 実行時刻
		ctx1.fillStyle = "#c66";
		for( var i=0; i<log_infos.length; i++){
			var startPos = NAME_WIDTH
				+ (
					roundHour(log_infos[i]['start'])
					- min_tm.getHours()
				) * HOUR_WIDTH;
			var endPos = NAME_WIDTH
				+ (
					roundHour(log_infos[i]['end'])
					- min_tm.getHours()
				) * HOUR_WIDTH;
			ctx1.fillRect(
				startPos,
				ONE_LINE_HEIGHT * (i+1) + LINE_PADDING,
				endPos - startPos,
				ONE_LINE_HEIGHT - LINE_PADDING*2
			);
		}
		// ジョブ名
		ctx1.fillStyle = "rgb(0,0,0)";
		ctx1.font = (ONE_LINE_HEIGHT-LINE_PADDING*2) + "px メイリオ";
		for( var i=0; i<log_infos.length; i++){
			ctx1.fillText(
				log_infos[i]['name'],
				LINE_PADDING,
				ONE_LINE_HEIGHT * (i+2) - LINE_PADDING
			)
		}

	}

	// 日時の時・分・秒から、時の小数点にする
	function roundHour(dt){
		return dt.getHours() + dt.getMinutes()/60 + dt.getSeconds()/(60*60);
	}
	
	// -->
	</script>
</head>

<body onload="onload()">
    <canvas
        id="can1"
        width="50" height="50"
        style="border:1px solid #393"
    ></canvas>
</body>

</html>